<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join SolarDrishti | Create Account</title>
    
    <link rel="icon" href="https://img.icons8.com/fluency/48/sun.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-orange: #ff9100;
            --bg-color: #f0f2f5;
            --text-color: #1a1a1a;
            --glass-bg: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] {
            --bg-color: #0b0e14;
            --text-color: #f1f1f1;
            --glass-bg: rgba(28, 33, 40, 0.9);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: 0.5s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        [data-theme="dark"] .nav-link { color: white !important; }

        .signup-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 100px 20px 50px 20px;
        }

        .signup-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            overflow: hidden;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
        }

        .signup-info {
            background: linear-gradient(135deg, var(--primary-orange), #ff6d00);
            color: white;
            padding: 40px;
            width: 40%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .signup-form-container { padding: 50px; width: 60%; }

        @media (max-width: 768px) {
            .signup-card { flex-direction: column; }
            .signup-info { width: 100%; padding: 30px; }
            .signup-form-container { width: 100%; padding: 30px; }
        }

        .form-control {
            border-radius: 12px;
            padding: 12px 20px;
            background: rgba(0,0,0,0.05);
            border: 1px solid transparent;
        }

        [data-theme="dark"] .form-control { background: rgba(255,255,255,0.05); color: white; }

        .btn-signup {
            background: linear-gradient(45deg, var(--primary-orange), #ff6d00);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px;
            border-radius: 12px;
        }

        /* --- OTP Section --- */
        #otp-section { display: none; }
        .otp-input {
            width: 45px;
            height: 55px;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            padding: 0;
            margin: 0 4px;
            border: 2px solid rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .otp-input { border: 2px solid rgba(255,255,255,0.1); }

        .otp-input:focus {
            border-color: var(--primary-orange);
            box-shadow: none;
            background: transparent;
        }

        #celestial-anchor {
            position: fixed; bottom: 25px; right: 25px; z-index: 2000;
            cursor: pointer; filter: drop-shadow(0 0 15px rgba(255, 145, 0, 0.4));
            width: 80px; height: 80px;
        }

        .login-link-text {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-top: 1.5rem;
        }

        .login-link-text a {
            color: var(--primary-orange);
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body onload="initApp()">

    <header>
        <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
            <div class="container">
                <a class="navbar-brand fw-bold d-flex align-items-center" href="{% url 'home' %}" style="color: var(--primary-orange);">
                    <i class="fa-solid fa-sun-plant-wilt me-2"></i> SOLAR<span class="text-secondary">DRISHTI</span>
                </a>
                <button class="navbar-toggler shadow-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navMain">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link px-3" href="{% url 'home' %}">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="/about/">About</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="signup-section">
        <div class="signup-card">
            <div class="signup-info d-none d-md-flex">
                <i class="fa-solid fa-solar-panel fa-4x mb-4"></i>
                <h2 class="fw-bold">Welcome!</h2>
                <p>Join SolarDrishti and start tracking your clean energy.</p>
            </div>

            <div class="signup-form-container">
                <div id="registration-section">
                    <h3 class="fw-bold mb-1">Create Account</h3>
                    <p class="text-muted mb-4 small">Enter details to receive an OTP</p>
                    
                    <form id="signupForm" autocomplete="off">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Username</label>
                            <input type="text" name="username" class="form-control" placeholder="User123" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Email Address</label>
                            <input type="email" id="userEmail" name="email" class="form-control" placeholder="name@example.com" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label small fw-bold">Password</label>
                            <input type="password" name="password" class="form-control" placeholder="********" required autocomplete="new-password">
                        </div>
                        <button
                        type="button"
                        class="btn btn-signup w-100"
                        id="sendOtpBtn"
                        >
                        Send OTP <i class="fa-solid fa-paper-plane ms-2"></i>
                        </button>
                        <script>
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("sendOtpBtn");
    if (!btn) return;

    btn.addEventListener("click", function () {
        const form = document.getElementById("signupForm");
        const formData = new FormData(form);

        fetch("{% url 'signup' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "sent") {
                document.getElementById("displayEmail").innerText =
                    document.getElementById("userEmail").value;

                document.getElementById("registration-section").style.display = "none";
                document.getElementById("otp-section").style.display = "block";
            } else {
                alert(data.message || "OTP failed");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Server error");
        });
    });
});
</script>


                    </form>
                    
                    <div class="text-center login-link-text">
                        Already have an account? <a href="{% url 'login' %}">Login</a>
                    </div>
                </div>

                <div id="otp-section" class="text-center">
                    <i class="fa-solid fa-envelope-open-text text-warning fa-3x mb-3"></i>
                    <h3 class="fw-bold">Email Verification</h3>
                    <p class="text-muted small">We sent a code to <br><b id="displayEmail"></b></p>
                    
                    <form id="otpVerifyForm" method="POST" autocomplete="off">
                        {% csrf_token %}
                        <div class="d-flex justify-content-center mb-4 mt-4">
                            <input type="tel" name="otp" class="form-control otp-input" maxlength="1" required>
                            <input type="tel" name="otp" class="form-control otp-input" maxlength="1" required>
                            <input type="tel" name="otp" class="form-control otp-input" maxlength="1" required>
                            <input type="tel" name="otp" class="form-control otp-input" maxlength="1" required>
                            <input type="tel" name="otp" class="form-control otp-input" maxlength="1" required>
                            <input type="tel" name="otp" class="form-control otp-input" maxlength="1" required>
                        </div>
                        <button type="submit" class="btn btn-signup w-100" onclick="handleFinalSignup(event)">Verify & Register</button>
                    </form>

                    <div class="text-center login-link-text">
                        Back to <a href="#" onclick="window.location.reload()">Registration</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <aside id="celestial-anchor" onclick="toggleTheme()">
        <svg width="100%" height="100%" viewBox="0 0 100 100">
            <circle id="main-circle" cx="50" cy="50" r="40" fill="#FFD700" />
            <g id="eyes">
                <circle cx="35" cy="45" r="7" fill="white" />
                <circle id="left-iris" class="iris" cx="35" cy="45" r="3.5" fill="black" />
                <circle cx="65" cy="45" r="7" fill="white" />
                <circle id="right-iris" class="iris" cx="65" cy="45" r="3.5" fill="black" />
            </g>
            <path id="mouth" d="M 40 65 Q 50 75 60 65" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" />
        </svg>
    </aside>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function initApp() {
            if (localStorage.getItem('theme') === 'dark') applyTheme('dark');
        }

        // OTP Input Auto-focus Logic
        const inputs = document.querySelectorAll('.otp-input');
        inputs.forEach((input, index) => {
            input.addEventListener('keyup', (e) => {
                if (input.value.length > 0 && inputs[index + 1]) inputs[index + 1].focus();
                if (e.key === "Backspace" && inputs[index - 1]) inputs[index - 1].focus();
            });
        });

 /*       function handleSendOTP(e) {
    e.preventDefault();
    const form = document.getElementById('signupForm');
    const formData = new FormData(form);

    // Send data to Django view
    fetch("{% url 'signup' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        if (response.ok) {
            // SUCCESS: Only switch to OTP section if the email is new
            document.getElementById('displayEmail').innerText = document.getElementById('userEmail').value;
            document.getElementById('registration-section').style.display = 'none';
            document.getElementById('otp-section').style.display = 'block';
        } else {
            // FAILURE: Handle errors like "Email already registered"
            return response.json().then(data => {
                alert(data.message || "Something went wrong. Please try again.");
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Server error. Please try again later.");
    });
}*/

    function handleFinalSignup(e) {
        e.preventDefault();
        const otpInputs = document.querySelectorAll('input[name="otp"]');
        let otpCode = "";
        otpInputs.forEach(input => otpCode += input.value); // Combines 6 digits into 1 string

        const formData = new FormData();
        formData.append('otp_code', otpCode); // This name MUST match the views.py name
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("/verify-otp/", {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                localStorage.setItem('isLoggedIn', 'true');
                window.location.href = "{% url 'home' %}";
            } else {
            alert("Invalid OTP. Please try again.");
            }
        });
    }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            applyTheme(isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        function applyTheme(mode) {
            const sun = document.getElementById('main-circle');
            if (mode === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                sun.setAttribute('fill', '#bdc3c7');
            } else {
                document.body.removeAttribute('data-theme');
                sun.setAttribute('fill', '#FFD700');
            }
        }

        document.addEventListener('mousemove', (e) => {
            const irises = document.querySelectorAll('.iris');
            irises.forEach(iris => {
                const rect = iris.getBoundingClientRect();
                const angle = Math.atan2(e.clientY - (rect.top + 3.5), e.clientX - (rect.left + 3.5));
                iris.style.transform = `translate(${Math.cos(angle) * 4}px, ${Math.sin(angle) * 4}px)`;
            });
        });
    </script>
</body>
</html>