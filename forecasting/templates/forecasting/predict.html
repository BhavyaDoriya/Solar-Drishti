<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predict | SolarDrishti Insights</title>
    
    <link rel="icon" href="https://img.icons8.com/fluency/48/sun.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css" />

    <style>
        :root {
            --primary-orange: #ff9100;
            --bg-color: linear-gradient(180deg, #e0f2ff 0%, #ffffff 400px); 
            --text-color: #1a1a1a;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #020617; 
            --text-color: #f1f1f1;
            --glass-bg: rgba(15, 23, 42, 0.8);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.6s ease;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- STABLE SPACE THEME --- */
        #warpCanvas { position: fixed; inset: 0; z-index: -2; pointer-events: none; opacity: 0; transition: opacity 1s ease; }
        [data-theme="dark"] #warpCanvas { opacity: 1; }
        [data-theme="dark"] body::before {
            content: " "; position: fixed; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
            z-index: 1000; pointer-events: none;
        }

        /* --- NAVBAR --- */
        .navbar { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border-bottom: 1px solid var(--glass-border); height: 60px; }
        .navbar-brand { font-family: 'Orbitron'; color: var(--primary-orange) !important; font-weight: 900; }
        [data-theme="dark"] .nav-link { color: #ffffff !important; }

        /* --- CARD UI --- */
        .system-card {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 20px; height: 100%; transition: 0.3s ease;
            display: flex; flex-direction: column;
        }
        .system-card:hover { transform: translateY(-5px); border-color: var(--primary-orange); }

        /* --- SPINNER --- */
        .spinner-border-sm { width: 1rem; height: 1rem; display: none; margin-right: 5px; }
        .predicting .spinner-border-sm { display: inline-block; }
        .predicting .btn-text { display: none; }
        .predicting::after { content: "Calculating..."; }

        .add-btn {
            width: 55px; height: 55px; background: linear-gradient(45deg, var(--primary-orange), #ff6d00);
            border-radius: 50%; border: none; color: white; font-size: 1.4rem;
            box-shadow: 0 8px 20px rgba(255, 145, 0, 0.3); cursor: pointer;
        }

        #map-picker { height: 280px; width: 100%; border-radius: 12px; border: 1px solid var(--glass-border); }

        /* --- MAP SEARCH FIX --- */
        .leaflet-geosearch-results, .leaflet-geosearch-bar form input { 
            background-color: var(--bg-color) !important; color: var(--text-color) !important;filter:invert(1); backdrop-filter: none !important; opacity: 1 !important; 
        }

        #celestial-anchor { position: fixed; bottom: 20px; right: 20px; z-index: 2000; width: 60px; height: 60px; cursor: pointer; }
        .cursor-dot, .cursor-outline { position: fixed; pointer-events: none; z-index: 9999; opacity: 0; }
        @media (pointer: fine) {
            [data-theme="dark"] .cursor-dot { display: block; width: 8px; height: 8px; background: var(--primary-orange); border-radius: 50%; top: 0; left: 0; opacity: 1; }
            [data-theme="dark"] .cursor-outline { display: block; width: 30px; height: 30px; border: 2px solid var(--primary-orange); border-radius: 50%; top: 0; left: 0; opacity: 1; transition: transform 0.1s ease-out; }
        }
        .leaflet-geosearch-results, 
.leaflet-geosearch-results .results,
.leaflet-geosearch-results .results > div,
.leaflet-geosearch-bar form,
.leaflet-geosearch-bar form input {
    background-color: #ffffff !important; /* Force solid white */
    color: #000000 !important;            /* Force solid black text */
    filter: none !important;               /* Remove any inversions */
    backdrop-filter: none !important;      /* Remove glass blur */
    opacity: 1 !important;                 /* Ensure no transparency */
    border: none !important;
}

/* Hover effect for the suggestions */
.leaflet-geosearch-results .results > div:hover {
    background-color: #f0f0f0 !important;
    color: var(--primary-orange) !important;
}

/* Fix for the magnifying glass/reset icons */
.leaflet-geosearch-bar a.reset {
    color: #000 !important;
    background: none !important;
}
    </style>
</head>
<body onload="initApp()">

    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>
    <canvas id="warpCanvas"></canvas>

    <header>
        <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="/"><i class="fa-solid fa-sun-plant-wilt me-2"></i> SOLAR<span class="text-secondary">DRISHTI</span></a>
                <div class="collapse navbar-collapse" id="navMain">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item"><a class="nav-link px-3" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-3 active-page" href="/predict/">Predict</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="/history/">History</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mt-5 pt-4">
        <div id="status-notif">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-dismissible fade show rounded-3 shadow-sm border-0 {% if message.tags == 'success' %}bg-success text-white{% else %}bg-warning text-dark{% endif %}" role="alert">
                        <i class="fa-solid {% if message.tags == 'success' %}fa-circle-check{% else %}fa-circle-exclamation{% endif %} me-2"></i> {{ message }}
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="row align-items-center mb-4">
            <div class="col-9">
                <h2 class="fw-bold m-0" style="font-family: 'Orbitron';">Solar Insights</h2>
                <p class="text-muted small" style="color:var(--text-color) !important; ">Manage hardware and generate accurate US forecasts.</p>
            </div>
            <div class="col-3 text-end">
                <button class="add-btn shadow" data-bs-toggle="modal" data-bs-target="#addSystemModal"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <div class="row g-3">
            {% for system in systems %}
            <div class="col-12 col-md-6 col-lg-4">
                <div class="system-card shadow-sm">
                    <h5 class="fw-bold m-0" style="color: var(--primary-orange);">{{ system.name }}</h5>
                    <small class="text-muted mb-3 d-block" style="color:var(--text-color) !important;"><i class="fa-solid fa-location-dot me-1"></i> {{ system.location_name }}</small>
                    <div class="row g-2 mt-auto">
                        <div class="col-6"><button class="btn btn-outline-warning w-100 rounded-pill fw-bold btn-sm" onclick="runPrediction(this, '{{ system.id }}', 'tomorrow')"><span class="spinner-border spinner-border-sm"></span><span class="btn-text">Tomorrow</span></button></div>
                        <div class="col-6"><button class="btn btn-outline-warning w-100 rounded-pill fw-bold btn-sm" onclick="runPrediction(this, '{{ system.id }}', 'day_after')"><span class="spinner-border spinner-border-sm"></span><span class="btn-text">Overmorrow</span></button></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0" style="background: var(--glass-bg); backdrop-filter: blur(20px); color: var(--text-color);">
                <div class="modal-header border-0"><h6 class="fw-bold">AI FORECAST ANALYSIS</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center p-4">
                    <i class="fa-solid fa-bolt text-warning fa-2x mb-3"></i>
                    <h2 id="result-value" class="fw-bold" style="color: var(--primary-orange);">-- kWh</h2>
                    <p id="result-date" class="text-muted small" style="color:var(--text-color) !important">Target Date: --</p>
                    
                    <button class="btn btn-sm btn-outline-warning rounded-pill mb-3 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#factorCollapse">
                        <i class="fa-solid fa-chart-line me-1"></i> View Impact Factors
                    </button>

                    <div class="collapse" id="factorCollapse">
                        <div class="p-3 rounded-3 border mb-3 text-start bg-light bg-opacity-10">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Solar Radiation (GHI) 
                                    <i class="fa-solid fa-circle-info ms-1 text-primary small" style="cursor:help;" 
                                       title="Global Horizontal Irradiance: The total amount of shortwave radiation received from above by a surface horizontal to the ground. Higher GHI = More power."></i>
                                </span>
                                <span id="factor-ghi" class="fw-bold text-orange">--</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Air Temperature 
                                    <i class="fa-solid fa-circle-info ms-1 text-primary small" style="cursor:help;" 
                                       title="Ambient temperature. Excessive heat can actually reduce solar panel efficiency."></i>
                                </span>
                                <span id="factor-temp" class="fw-bold text-orange">--</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Wind Speed 
                                    <i class="fa-solid fa-circle-info ms-1 text-primary small" style="cursor:help;" 
                                       title="Wind helps cool panels down, potentially improving performance in hot conditions."></i>
                                </span>
                                <span id="factor-wind" class="fw-bold text-orange">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0"><button class="btn btn-warning w-100 rounded-pill fw-bold py-2" data-bs-dismiss="modal">DISMISS</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addSystemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0" style="background: var(--glass-bg); backdrop-filter: blur(20px);">
                <form id="addSystemForm" method="POST" action="{% url 'add_system' %}">
                    {% csrf_token %}
                    <div class="modal-header border-0"><h6 class="fw-bold m-0">REGISTER SYSTEM</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body pt-0">
                        <div class="row g-2 mb-3">
                            <div class="col-8"><input type="text" name="name" class="form-control form-control-sm" placeholder="System Name" required></div>
                            <div class="col-4"><input type="number" step="0.1" name="size" class="form-control form-control-sm" placeholder="kW Size" required></div>
                        </div>
                        <div id="map-picker"></div>
                        <div id="location-status" class="alert alert-info py-2 small border-0 mt-2" style="background:#fff !important; color:#000 !important; border:1px solid var(--primary-orange) !important;">Search US address; coordinates update auto.</div>
                    </div>
                    <div class="modal-footer border-0 pt-0"><button type="submit" class="btn btn-warning w-100 rounded-pill fw-bold py-2 shadow-sm" id="save-sys-btn" disabled>VERIFY & ADD</button></div>
                    <input type="hidden" name="lat" id="sys-lat"><input type="hidden" name="lon" id="sys-lon">
                </form>
            </div>
        </div>
    </div>

    <aside id="celestial-anchor" onclick="toggleTheme()">
        <svg width="100%" height="100%" viewBox="0 0 100 100">
            <circle id="main-circle" cx="50" cy="50" r="40" fill="#FFD700" />
            <g id="eyes"><circle cx="35" cy="45" r="7" fill="white" /><circle class="iris" cx="35" cy="45" r="3.5" fill="black" /><circle cx="65" cy="45" r="7" fill="white" /><circle class="iris" cx="65" cy="45" r="3.5" fill="black" /></g>
            <path id="mouth" d="M 40 65 Q 50 75 60 65" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" />
        </svg>
    </aside>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let map, marker;
    const US_BOUNDS = L.latLngBounds([24.39, -125.0], [49.38, -66.93]);

    function initApp() { 
        if (localStorage.getItem('theme') === 'dark') applyTheme('dark'); 
        animateWarp();
    }

    // --- FIXED PREDICTION FETCH LOGIC ---
    // Added 'btn' as the first argument to match the HTML call
    function runPrediction(btn, systemId, targetDay) {
        btn.classList.add('predicting');
        btn.disabled = true;

        fetch(`/run-prediction/${systemId}/?day=${targetDay}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    // 1. Update Energy Display
                    document.getElementById('result-value').innerText = data.predicted_energy + " kWh";
                    document.getElementById('result-date').innerText = "Target Date: " + data.date;
                    
                    // 2. Populate Environmental Factors
                    document.getElementById('factor-ghi').innerText = data.factors.ghi + " W/m²";
                    document.getElementById('factor-temp').innerText = data.factors.temp + " °C";
                    document.getElementById('factor-wind').innerText = data.factors.wind + " m/s";

                    // 3. Reset the collapse (hide factors for new result)
                    const collapseContent = document.getElementById('factorCollapse');
                    const bsCollapse = bootstrap.Collapse.getInstance(collapseContent);
                    if (bsCollapse) bsCollapse.hide();
                    
                    // 4. Show the Bootstrap Modal
                    const myModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    myModal.show();

                    // Reload on close to update history
                    document.getElementById('resultModal').addEventListener('hidden.bs.modal', function () {
                        location.reload();
                    }, {once: true});

                } else { 
                    alert("Error: " + data.message); 
                }
            })
            .catch(err => {
                console.error(err);
                alert("Network communication error.");
            })
            .finally(() => { 
                btn.classList.remove('predicting'); 
                btn.disabled = false; 
            });
    }
    // --- MAP LOGIC ---
    document.getElementById('addSystemModal').addEventListener('shown.bs.modal', function () {
        if (!map) {
            map = L.map('map-picker', { maxBounds: US_BOUNDS, maxBoundsViscosity: 1.0 }).setView([37.09, -95.71], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const provider = new window.GeoSearch.OpenStreetMapProvider({ params: { countrycodes: 'us', viewbox: "-125,24,-66,49", bounded: 1 } });
            const search = new window.GeoSearch.GeoSearchControl({ provider: provider, style: 'bar', showMarker: false, autoClose: true, keepResult: true });
            map.addControl(search);
            marker = L.marker([37.09, -95.71], { draggable: true }).addTo(map);

            map.on('geosearch/showlocation', (e) => { 
                marker.setLatLng([e.location.y, e.location.x]); 
                updateCoords(e.location.y, e.location.x); 
            });

            marker.on('dragend', () => { 
                const pos = marker.getLatLng(); 
                if (!US_BOUNDS.contains(pos)) { 
                    marker.setLatLng([37.09, -95.71]); 
                    alert("US only."); 
                } else {
                    updateCoords(pos.lat, pos.lng); 
                }
            });
            map.on('click', (e) => { 
                if (US_BOUNDS.contains(e.latlng)) { 
                    marker.setLatLng(e.latlng); 
                    updateCoords(e.latlng.lat, e.latlng.lng); 
                } 
            });
        } else { 
            setTimeout(() => map.invalidateSize(), 200); 
        }
    });

    function updateCoords(lat, lon) {
        document.getElementById('sys-lat').value = lat; 
        document.getElementById('sys-lon').value = lon;
        document.getElementById('save-sys-btn').disabled = false;
        document.getElementById('location-status').innerHTML = `Telemetry Locked: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    }

    // --- ANIMATION & THEME LOGIC ---
    const canvas = document.getElementById('warpCanvas'), ctx = canvas.getContext('2d');
    let stars = Array(350).fill().map(() => ({ x: Math.random()*innerWidth-innerWidth/2, y: Math.random()*innerHeight-innerHeight/2, z: Math.random()*innerWidth }));
    
    function animateWarp() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        ctx.fillStyle = isDark ? "rgba(2, 6, 23, 0.4)" : "rgba(255, 255, 255, 0)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if(isDark) {
            stars.forEach(s => {
                s.z -= 1.5; if (s.z <= 0) s.z = canvas.width;
                const x = (s.x / s.z) * canvas.width + canvas.width/2, y = (s.y / s.z) * canvas.height + canvas.height/2, size = (1 - s.z/canvas.width) * 2;
                ctx.beginPath(); ctx.fillStyle = "white"; ctx.arc(x, y, size, 0, Math.PI*2); ctx.fill();
            });
        }
        requestAnimationFrame(animateWarp);
    }

    const dot = document.querySelector('.cursor-dot'), outline = document.querySelector('.cursor-outline');
    window.addEventListener('mousemove', (e) => {
        dot.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
        outline.animate({ transform: `translate(${e.clientX - 15}px, ${e.clientY - 15}px)` }, { duration: 400, fill: "forwards" });
        document.querySelectorAll('.iris').forEach(iris => {
            const rect = iris.getBoundingClientRect(), angle = Math.atan2(e.clientY - (rect.top + 3.5), e.clientX - (rect.left + 3.5));
            iris.style.transform = `translate(${Math.cos(angle) * 3}px, ${Math.sin(angle) * 3}px)`;
        });
    });

    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        applyTheme(isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function applyTheme(mode) {
        const sun = document.getElementById('main-circle');
        document.body.setAttribute('data-theme', mode);
        if(sun) sun.setAttribute('fill', mode === 'dark' ? '#bdc3c7' : '#FFD700');
    }
    function showAnalytics() {
        const myModal = new bootstrap.Modal(document.getElementById('analyticsModal'));
        myModal.show();
    }
</script>
</body>
</html>