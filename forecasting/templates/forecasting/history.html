<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy History | SolarDrishti</title>
    
    <link rel="icon" href="https://img.icons8.com/fluency/48/sun.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-orange: #ff9100;
            --bg-color: linear-gradient(180deg, #e0f2ff 0%, #ffffff 400px); 
            --text-color: #1a1a1a;
            --glass-card: rgba(255, 255, 255, 0.95);
            --border: rgba(0, 0, 0, 0.08);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
            
            /* NEW: Solid background color for button hover text */
            --bg-solid: #ffffff; 
        }

        [data-theme="dark"] {
            --bg-color: #020617; 
            --text-color: #f1f1f1;
            --glass-card: rgba(15, 23, 42, 0.85);
            --border: rgba(255, 255, 255, 0.15);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.2);
            
            /* NEW: Solid background color for button hover text */
            --bg-solid: #020617; 
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.6s ease;
            min-height: 100vh;
        }

        /* --- TYPOGRAPHY FIXES --- */
        h1, h2, h3, h4, h5, h6, 
        .navbar-brand, 
        .nav-link, 
        .stat-card .val,
        th {
            font-family: 'Orbitron', sans-serif !important;
        }

        /* --- NAVBAR --- */
        .navbar { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); }
        .navbar-brand { font-weight: 900; color: var(--primary-orange) !important; letter-spacing: 2px; }
        
        .nav-link {
            font-size: 13px !important;
            font-weight: 400;
            letter-spacing: 0.5px;
            color: var(--text-color) !important;
            transition: 0.3s;
        }
        
        .nav-link:hover { color: var(--primary-orange) !important; text-shadow: 0 0 8px var(--primary-orange); }
        
        /* --- FIX 2: MATCHED CLASS NAME (.active-page) --- */
        .nav-link.active-page { 
            color: var(--primary-orange) !important; 
            font-weight: 700 !important; 
            border-bottom: 2px solid var(--primary-orange); 
        }

        .dashboard-container { padding-top: 100px; }

        /* --- STAT CARDS --- */
        .stat-card {
            background: var(--glass-card);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            border-top: 5px solid var(--primary-orange); /* Restored Top Border */
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card small { letter-spacing: 1px; font-weight: 600; opacity: 0.7; text-transform: uppercase; font-size: 0.8rem; }
        .stat-card .val { font-size: 2.5rem; font-weight: 900; margin-top: 10px; color: var(--text-color); }
        
        .stat-card .val.text-success { color: #28a745 !important; }

        /* --- HISTORY TABLE --- */
        .history-card-fixed {
            background: var(--glass-card) !important;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        /* --- FIX 3: DARK MODE TABLE VISIBILITY --- */
        .history-card-fixed th { 
            color: var(--text-color); 
            opacity: 0.6; 
            text-transform: uppercase; 
            font-size: 0.8rem; 
            padding: 15px; 
            border-bottom: 1px solid var(--border);
        }
        
        .history-card-fixed td { 
            color: var(--text-color); /* Uses variable so it works in dark mode */
            font-weight: 500; 
            padding: 15px; 
            border-bottom: 1px solid var(--border);
        }

        .text-muted { color: var(--text-color) !important; opacity: 0.5; }
        .text-dark { color: var(--text-color) !important; }

        /* --- BADGES & BUTTONS --- */
        .accuracy-badge { padding: 6px 14px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
        .bg-high { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid rgba(40, 167, 69, 0.3); }

        .btn-orange { 
            background: linear-gradient(45deg, var(--primary-orange), #ff6d00); 
            color: white; border-radius: 50px; font-weight: 700; border: none; padding: 10px 30px; 
            box-shadow: 0 4px 15px rgba(255, 145, 0, 0.3);
        }
        .btn-orange:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 145, 0, 0.5); color: white; }

        /* --- CELESTIAL ANCHOR --- */
        #celestial-anchor { position: fixed; bottom: 25px; right: 25px; z-index: 2000; cursor: pointer; width: 85px; height: 85px; }
        .sun-glow #main-circle { filter: drop-shadow(0 0 15px rgba(255, 145, 0, 0.8)); }
        .moon-glow #main-circle { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.6)); }

        /* --- MODAL FIXES --- */
        .modal-content { background: var(--glass-card); backdrop-filter: blur(20px); border: 1px solid var(--border); color: var(--text-color); }
        .modal-header, .modal-footer { border-color: var(--border); }
        
        /* Invert close button in dark mode */
        .btn-close { filter: invert(var(--invert-val)); }
        [data-theme="dark"] { --invert-val: 1; }
        [data-theme="light"] { --invert-val: 0; }
        
        /* Custom Alert Borders */
        .border-success-custom { border-left: 5px solid #28a745 !important; }
        .border-warning-custom { border-left: 5px solid #ffc107 !important; }
        .border-danger-custom { border-left: 5px solid #dc3545 !important; }
        .border-info-custom { border-left: 5px solid #17a2b8 !important; }
        /* --- STABLE SPACE THEME BACKGROUND --- */
        #warpCanvas { position: fixed; inset: 0; z-index: -2; pointer-events: none; opacity: 0; transition: opacity 1s ease; }
        [data-theme="dark"] #warpCanvas { opacity: 1; }
        [data-theme="dark"] body::before {
            content: " "; position: fixed; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 1000; background-size: 100% 4px, 3px 100%; pointer-events: none;
        }

        /* --- NAVBAR BLEND FIX (Dark Mode) --- */
        [data-theme="dark"] .navbar {
            background: rgba(15, 23, 42, 0.9) !important; /* Darker glass stops table from bleeding through */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- BOOTSTRAP TABLE OVERRIDES (The fix for the ugly white blocks) --- */
        .table {
            --bs-table-bg: transparent; /* Stops bootstrap from forcing white backgrounds */
            --bs-table-color: var(--text-color);
        }
        .table td, .table th {
            background-color: transparent !important;
            border-bottom-color: var(--border);
        }
        
        /* Force Bootstrap text colors to invert in dark mode */
        [data-theme="dark"] .text-dark { color: #f8fafc !important; }
        [data-theme="dark"] .text-muted { color: #94a3b8 !important; opacity: 1; }
        [data-theme="dark"] .history-card-fixed td, 
        [data-theme="dark"] .history-card-fixed th {
            color: #f1f1f1 !important;
        }
        /* --- FIX: Invert Hamburger Icon in Dark Mode --- */
        [data-theme="dark"] .navbar-toggler-icon { filter: invert(1); }
       .btn-report {
            background: transparent;
            color: var(--text-color) !important;
            border: 2px solid var(--text-color) !important;
            transition: all 0.3s ease;
        }
        .btn-report:hover {
            background: var(--text-color) !important;
            /* Uses the solid color instead of the gradient */
            color: var(--bg-solid) !important; 
        }
        #scroll-progress { 
            position: fixed; top: 0; left: 0; width: 0%; height: 3px; 
            background: var(--primary-orange); z-index: 9999; 
            box-shadow: 0 0 10px var(--primary-orange); 
        }
        .vignette { 
            position: fixed; inset: 0; z-index: -1; pointer-events: none; 
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.4) 100%); 
        }
         /* --- DROPDOWN MENU HOVER FIX --- */
        .dropdown-menu {
            /* This fallback chain automatically finds the right variable for the page! */
            background: var(--glass-bg, var(--glass-card, var(--card-bg))) !important;
            backdrop-filter: blur(25px) !important;
            border: 1px solid var(--glass-border, var(--border)) !important;
            border-radius: 15px !important;
            overflow: hidden; 
            padding: 5px 0;
        }
        
        .dropdown-item {
            color: var(--text-color) !important;
            padding: 10px 20px;
            transition: all 0.2s ease;
        }
        
        .dropdown-item:hover {
            background-color: rgba(255, 145, 0, 0.15) !important; /* Soft orange highlight */
            color: var(--primary-orange) !important; /* Text turns orange */
        }
        
        /* Keep the logout button red on hover */
        .dropdown-item.text-danger:hover {
            background-color: rgba(220, 53, 69, 0.15) !important; 
            color: #dc3545 !important;
        }
          /* --- CUSTOM CURSOR (Light & Dark Mode) --- */
        .cursor-dot, .cursor-outline { 
            position: fixed; 
            pointer-events: none; 
            z-index: 9999; 
            opacity: 0; /* Hidden by default (prevents it from showing on mobile touch screens) */
        }
        
        @media (pointer: fine) {
            /* Hide native cursor on ALL themes */
            body, html { cursor: none !important; }
            a, button, input, select, label, .flip-card, .dropdown-item { cursor: none !important; }
            
            /* Show custom cursor dots on ALL themes */
            .cursor-dot { 
                display: block; 
                width: 8px; 
                height: 8px; 
                background: var(--primary-orange); 
                border-radius: 50%; 
                top: 0; 
                left: 0; 
                opacity: 1; 
                box-shadow: 0 0 10px var(--primary-orange); 
            }
            .cursor-outline { 
                display: block; 
                width: 30px; 
                height: 30px; 
                border: 2px solid var(--primary-orange); 
                border-radius: 50%; 
                top: 0; 
                left: 0; 
                opacity: 1; 
                transition: transform 0.15s ease-out; 
            }
        }
    </style>
</head>
<body onload="checkTheme()">
<div id="scroll-progress"></div>
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>
    <canvas id="warpCanvas"></canvas>
    <div class="vignette"></div>    <header>
        <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <i class="fa-solid fa-sun-plant-wilt me-2"></i> SOLAR<span class="text-secondary">DRISHTI</span>
                </a>

                <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navMain">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item"><a class="nav-link px-3" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="/predict/">Predict</a></li>
                        <li class="nav-item"><a class="nav-link px-3 active-page" href="/history/">History</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="/about/">About</a></li>

                        {% if user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle px-3" href="#" id="profileDrop" data-bs-toggle="dropdown">
                                <i class="fa-solid fa-circle-user"></i> {{ user.username|upper }}
                            </a>
                             <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="background: var(--card-bg); backdrop-filter: blur(10px); --bs-dropdown-divider-bg: var(--text-color);">
                                <li><a class="dropdown-item" href="{% url 'profile_view' user_id=request.user.id %}">View Profile</a></li>
                                <li><a class="dropdown-item" href="{% url 'update_profile' %}">Update Profile</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger fw-bold" href="{% url 'logout' %}">Logout</a></li>
                            </ul>
                        </li>
                        {% else %}
                        <li class="nav-item ms-lg-3">
                            <a href="{% url 'login' %}" class="btn btn-warning rounded-pill px-4 fw-bold shadow">Sign-in</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    {% if messages %}
    <div class="container mt-5 pt-5" id="message-container" style="position: relative; z-index: 1050;">
        {% for message in messages %}
            <div class="alert alert-dismissible fade show rounded-4 border-0 shadow-lg mb-3 d-flex align-items-center 
                {% if message.tags == 'success' %}border-success-custom
                {% elif message.tags == 'warning' %}border-warning-custom
                {% elif message.tags == 'error' or message.tags == 'danger' %}border-danger-custom
                {% else %}border-info-custom{% endif %}" 
                 role="alert" 
                 style="background: var(--glass-card); backdrop-filter: blur(10px);">
                
                <div class="d-flex align-items-center w-100">
                    <span style="color: var(--text-color); font-weight: 500;">
                        <i class="fa-solid {% if message.tags == 'success' %}fa-circle-check text-success{% elif message.tags == 'warning' %}fa-triangle-exclamation text-warning{% else %}fa-circle-info text-info{% endif %} me-2"></i>
                        {{ message }}
                    </span>
                </div>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="container dashboard-container mb-5">
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-card">
                    <small class="block mb-2">Total Logs</small>
                    <div class="val">{{ history_list|length }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <small class="block mb-2">Avg Accuracy</small>
                    <p class="val text-success">{{ avg_acc }}%</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <small class="block mb-2">Active Systems</small>
                    <div class="val" style="color: var(--primary-orange);">{{ system_count|default:0 }}</div>
                </div>
            </div>
        </div>

        <div class="row align-items-center mb-4 g-3">
            <div class="col-md-4 text-center text-md-start">
                <h2 class="fw-bold mb-0">Energy History</h2>
            </div>
            <div class="col-md-8 d-flex flex-wrap justify-content-center justify-content-md-end gap-3">
                <div class="input-group" style="max-width: 350px;">
                    <span class="input-group-text bg-white border-end-0" style="border-radius: 50px 0 0 50px;">
                        <i class="fa-solid fa-magnifying-glass text-warning"></i>
                    </span>
                    <input type="text" id="tableFilter" placeholder="Search date..." class="form-control border-start-0 shadow-none">
                    <button class="btn btn-orange px-4" type="button" onclick="filterTable()" style="border-radius: 0 50px 50px 0;">Search</button>
                </div>

                <button class="btn btn-report rounded-pill px-4 fw-bold" onclick="exportToPDF()">Report</button>
                <button class="btn btn-orange shadow-sm" data-bs-toggle="modal" data-bs-target="#analyticsModal">Analytics</button>
            </div>
        </div>

        <div class="history-card-fixed">
            <div class="table-responsive">
                <table class="table align-middle" id="historyTable">
                    <thead>
                        <tr>
                            <th>Commit Date</th>
                            <th>Forecast Date</th>
                            <th>Predicted</th>
                            <th>Actual Output</th>
                            <th>Accuracy</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        {% for entry in history_list %}
                        <tr>
                            <td class="text-muted small">{{ entry.created_at|date:"M d, H:i" }}</td>
                            <td class="text-dark">{{ entry.target_date|date:"M d, Y" }}</td>
                            <td style="color: var(--primary-orange);">{{ entry.pred_value }} kWh</td>
                            <td>
                                {% if entry.actual_value is not None %}
                                    <span class="text-success fw-bold me-2">{{ entry.actual_value }} kWh</span>
                                    <button class="btn p-0 border-0 bg-transparent" style="color: var(--primary-orange);" onclick="openEditModal(event, '{{ entry.id }}', '{{ entry.target_date }}', '{{ entry.actual_value }}')">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                {% else %}
                                    <span class="text-muted fst-italic me-2">Pending</span>
                                    <button class="btn p-0 border-0 bg-transparent text-primary" onclick="openEditModal(event, '{{ entry.id }}', '{{ entry.target_date }}', '')">
                                        <i class="fa-solid fa-plus-circle"></i>
                                    </button>
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.accuracy %}
                                    <span class="accuracy-badge {% if entry.accuracy > 90 %}bg-high{% endif %}">{{ entry.accuracy }}%</span>
                                {% else %}
                                    <span class="text-muted opacity-50">--</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if entry.actual_value is not None %}
                                    <i class="fa-solid fa-circle-check text-success fs-5"></i>
                                {% else %}
                                    <i class="fa-solid fa-clock-rotate-left text-muted opacity-50 fs-5"></i>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="noMatch" class="d-none text-center py-5 text-muted">
                <i class="fa-solid fa-calendar-xmark fs-1 mb-3 d-block opacity-25"></i>
                No matching records found.
            </div>
        </div>
    </main>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 shadow-lg overflow-hidden">
                <form method="POST" action="{% url 'manual_update_actual' %}">
                    {% csrf_token %}
                    <input type="hidden" name="prediction_id" id="modal_prediction_id">
                    <div class="p-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="fw-bold text-dark mb-0">Verify Output</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <p class="text-muted mb-4">Actual output for <span id="modal_date_display" class="fw-bold" style="color: var(--primary-orange);"></span>.</p>
                        <div class="mb-4">
                            <label class="form-label small fw-bold">Energy Generated (kWh)</label>
                            <input type="number" step="0.01" name="actual_val" id="modal_actual_val" class="form-control rounded-4 py-3" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-light rounded-pill flex-grow-1 py-3 fw-bold" data-bs-dismiss="modal">Discard</button>
                            <button type="submit" class="btn btn-orange flex-grow-1 py-3">Verify Now</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 shadow-lg">
                <div class="p-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold text-dark mb-0">Generation Trends</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div style="height: 400px;"><canvas id="historyChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <aside id="celestial-anchor" onclick="toggleTheme()">
        <svg width="100%" height="100%" viewBox="0 0 100 100">
            <circle id="main-circle" cx="50" cy="50" r="40" fill="#FFD700" />
            <g id="eyes"><circle cx="35" cy="45" r="7" fill="white" /><circle class="iris" cx="35" cy="45" r="3.5" fill="black" /><circle cx="65" cy="45" r="7" fill="white" /><circle class="iris" cx="65" cy="45" r="3.5" fill="black" /></g>
            <path id="mouth" d="M 40 65 Q 50 75 60 65" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" />    
        </svg>
    </aside>

    <script id="history-labels" type="application/json">[{% for entry in history_list|slice:":10" %}"{{ entry.target_date|date:'d M' }}"{% if not forloop.last %},{% endif %}{% endfor %}]</script>
    <script id="history-pred" type="application/json">[{% for entry in history_list|slice:":10" %}{{ entry.pred_value|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}]</script>
    <script id="history-actual" type="application/json">[{% for entry in history_list|slice:":10" %}{{ entry.actual_value|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}]</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // WORKING SEARCH FILTER
        function filterTable() {
            const input = document.getElementById("tableFilter");
            const filter = input.value.toLowerCase().trim();
            const rows = document.querySelectorAll("#historyBody tr");
            let hasMatch = false;

            rows.forEach(row => {
                if (row.innerText.toLowerCase().includes(filter)) {
                    row.classList.remove('d-none');
                    hasMatch = true;
                } else {
                    row.classList.add('d-none');
                }
            });
            document.getElementById("noMatch").classList.toggle("d-none", hasMatch);
        }

        // Enter key triggers search
        document.getElementById("tableFilter").addEventListener("keypress", (e) => {
            if (e.key === "Enter") filterTable();
        });

        // EYE TRACKING
       // --- EYETRACKING & CUSTOM CURSOR ---
        const dot = document.querySelector('.cursor-dot');
        const outline = document.querySelector('.cursor-outline');
        
        document.addEventListener('mousemove', (e) => {
            // 1. Move the Custom Cursor (only active in dark mode via CSS)
            if (dot && outline) {
                dot.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
                outline.animate({ transform: `translate(${e.clientX - 15}px, ${e.clientY - 15}px)` }, { duration: 400, fill: "forwards" });
            }

            // 2. Move the Celestial Eye Irises
            document.querySelectorAll('.iris').forEach(iris => {
                const rect = iris.getBoundingClientRect();
                const angle = Math.atan2(e.clientY - (rect.top + 3.5), e.clientX - (rect.left + 3.5));
                iris.style.transform = `translate(${Math.cos(angle) * 3}px, ${Math.sin(angle) * 3}px)`;
            });
        });

        // CHART LOGIC
        // CHART LOGIC (UPDATED FOR DARK MODE)
        let chartInstance = null;
        document.getElementById('analyticsModal').addEventListener('shown.bs.modal', function () {
            const ctx = document.getElementById('historyChart').getContext('2d');
            const labels = JSON.parse(document.getElementById('history-labels').textContent).reverse();
            const predData = JSON.parse(document.getElementById('history-pred').textContent).reverse().map(Number);
            const actualData = JSON.parse(document.getElementById('history-actual').textContent).reverse().map(Number);
            
            // --- NEW: DETECT THEME FOR CHART COLORS ---
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#f8fafc' : '#334155'; // White in dark mode, Slate in light mode
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; 
            // ------------------------------------------

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Forecast', data: predData, borderColor: '#ff9100', borderWidth: 4, tension: 0.3, pointRadius: 5 },
                        { label: 'Actual', data: actualData, borderColor: '#28a745', borderWidth: 4, tension: 0.3, pointRadius: 5, fill: true, backgroundColor: 'rgba(40, 167, 69, 0.05)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textColor, font: { family: 'Poppins', weight: 'bold' } } } },
                    scales: {
                        y: { 
                            grid: { color: gridColor }, // Adapts grid lines
                            ticks: { color: textColor }, // Adapts numbers
                            title: { display: true, text: 'Energy Output (kWh)', color: textColor, font: { weight: 'bold' } } 
                        },
                        x: { 
                            grid: { color: gridColor }, // Adapts grid lines
                            ticks: { color: textColor }, // Adapts dates
                            title: { display: true, text: 'Date', color: textColor, font: { weight: 'bold' } } 
                        }
                    }
                }
            });
        });
        function openEditModal(event, id, date, val) {
            event.preventDefault();
            document.getElementById('modal_prediction_id').value = id;
            document.getElementById('modal_date_display').innerText = date;
            document.getElementById('modal_actual_val').value = val;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // THEME LOGIC
        function checkTheme() { applyTheme(localStorage.getItem('theme') || 'light'); 
            animateWarp();
        }
        function toggleTheme() { 
            const isDark = document.body.getAttribute('data-theme') === 'dark'; 
            applyTheme(isDark ? 'light' : 'dark'); 
            localStorage.setItem('theme', isDark ? 'light' : 'dark'); 
        }
        function applyTheme(mode) {
            const sun = document.getElementById('main-circle');
            const container = document.getElementById('celestial-anchor'); 
            
            document.body.setAttribute('data-theme', mode);
            
            if (sun && container) {
                sun.setAttribute('fill', mode === 'dark' ? '#bdc3c7' : '#FFD700');
                container.classList.remove('sun-glow', 'moon-glow');
                container.classList.add(mode === 'dark' ? 'moon-glow' : 'sun-glow');
            }

            // --- NEW: DYNAMICALLY UPDATE CHART COLORS IF IT IS OPEN ---
            if (typeof chartInstance !== 'undefined' && chartInstance !== null) {
                const isDark = mode === 'dark';
                const textColor = isDark ? '#f8fafc' : '#334155'; 
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; 

                // Update Legend
                chartInstance.options.plugins.legend.labels.color = textColor;
                
                // Update X-Axis
                chartInstance.options.scales.x.ticks.color = textColor;
                chartInstance.options.scales.x.title.color = textColor;
                chartInstance.options.scales.x.grid.color = gridColor;
                
                // Update Y-Axis
                chartInstance.options.scales.y.ticks.color = textColor;
                chartInstance.options.scales.y.title.color = textColor;
                chartInstance.options.scales.y.grid.color = gridColor;
                
                // Force Chart to re-render
                chartInstance.update();
            }
        }
        // --- WARP ENGINE (Space Theme) ---
        const canvas = document.getElementById('warpCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        let stars = Array(window.innerWidth < 768 ? 150 : 350).fill().map(() => ({ 
            x: Math.random()*innerWidth-innerWidth/2, 
            y: Math.random()*innerHeight-innerHeight/2, 
            z: Math.random()*innerWidth 
        }));
        
        function animateWarp() {
            if (!canvas || !ctx) return;
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight;
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            
            ctx.fillStyle = isDark ? "rgba(2, 6, 23, 0.4)" : "rgba(255, 255, 255, 0)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if(isDark) {
                stars.forEach(s => {
                    s.z -= 1.5; if (s.z <= 0) s.z = canvas.width;
                    const x = (s.x / s.z) * canvas.width + canvas.width/2;
                    const y = (s.y / s.z) * canvas.height + canvas.height/2;
                    const size = (1 - s.z/canvas.width) * 2;
                    
                    ctx.beginPath(); 
                    ctx.fillStyle = "white"; 
                    ctx.arc(x, y, size, 0, Math.PI*2); 
                    ctx.fill();
                });
            }
            requestAnimationFrame(animateWarp);
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            doc.autoTable({ html: '#historyTable', startY: 35, theme: 'striped', headStyles: { fillColor: [255, 145, 0] } });
            doc.save("SolarDrishti_Log.pdf");
        }
        // SCROLL PROGRESS TRACKER
        window.onscroll = function() {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            const progress = document.getElementById("scroll-progress");
            if (progress) progress.style.width = scrolled + "%";
        };
    </script>
</body>
</html>